<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Area Riservata - Studio Legale BCS</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#4fffac",
                        "primary-dark": "#2be68e",
                        "secondary": "#3a6b54",
                        "surface": "#ffffff",
                        "surface-accent": "#f0fdf7",
                        "text-main": "#1a3326",
                        "text-light": "#6b7280"
                    },
                    fontFamily: {
                        sans: ['Space Grotesk', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #9ca3af;
            border-radius: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            color: #4fffac;
            background-color: rgba(79, 255, 172, 0.05);
        }

        .sidebar-link.active {
            color: #1a3326;
            font-weight: 700;
            border-left: 3px solid #4fffac;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
        }
    </style>
</head>

<body class="h-screen flex text-text-main overflow-hidden font-sans antialiased">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-gray-100 flex flex-col justify-between shrink-0 h-full">
        <div class="p-6">
            <!-- Brand -->
            <div class="flex items-center gap-2 mb-10">
                <span class="text-2xl font-bold tracking-tight text-[#1a3326]">Doc<span
                        class="text-[#4fffac]">Legal</span></span>
            </div>

            <!-- Nav -->
            <nav class="space-y-2">
                <a href="#" class="sidebar-link active" onclick="switchView('home')">
                    <span class="material-symbols-outlined">home</span>
                    Homepage
                </a>
                <a href="#" class="sidebar-link" onclick="switchView('home')">
                    <span class="material-symbols-outlined">folder_shared</span>
                    Le mie Pratiche
                </a>
                <a href="#" class="sidebar-link" onclick="switchView('calendar')">
                    <span class="material-symbols-outlined">calendar_month</span>
                    Calendario
                </a>
                <a href="#" onclick="switchView('messages')" class="sidebar-link">
                    <span class="material-symbols-outlined">chat</span>
                    Messaggi
                    <span id="msg-badge"
                        class="ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span>
                </a>
                <a href="#" class="sidebar-link" onclick="switchView('settings')">
                    <span class="material-symbols-outlined">settings</span>
                    Impostazioni
                </a>
            </nav>
        </div>

        <!-- Upgrade / Contact Banner -->
        <div class="p-6">
            <div
                class="bg-surface-accent rounded-2xl p-4 text-center relative overflow-hidden border border-primary/20">
                <div class="absolute -right-4 -top-4 w-16 h-16 bg-primary/20 rounded-full blur-2xl"></div>
                <span class="material-symbols-outlined text-3xl text-[#3a6b54] mb-2">rocket_launch</span>
                <h4 class="font-bold text-sm mb-1 text-[#1a3326]">Hai bisogno di aiuto?</h4>
                <p class="text-xs text-secondary mb-3">Prenota una consulenza prioritaria.</p>
                <button
                    class="w-full bg-[#4fffac] hover:bg-[#2be68e] text-[#1a3326] text-xs font-bold py-2 rounded-lg transition-colors">
                    Prenota Ora
                </button>
            </div>
            <button onclick="AuthService.logout()"
                class="mt-4 flex items-center gap-2 text-sm text-gray-400 hover:text-red-500 w-full px-2">
                <span class="material-symbols-outlined text-lg">logout</span> Logout
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-[#fafafa]">

        <!-- Header -->
        <header class="h-20 flex items-center justify-between px-8 bg-white border-b border-gray-100">
            <!-- Search -->
            <div class="relative w-96">
                <span
                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-300">search</span>
                <input type="text" placeholder="Cerca nelle pratiche..."
                    class="w-full bg-gray-50 border-none rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-primary/50 text-gray-600">
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                    <span class="text-sm font-medium text-gray-500" id="current-date">Ven 15 Set 13:55</span>
                </div>

                <div class="flex items-center gap-3">
                    <button
                        class="w-10 h-10 rounded-xl bg-white border border-gray-100 flex items-center justify-center text-gray-400 hover:text-primary shadow-sm">
                        <span class="material-symbols-outlined">notifications</span>
                    </button>
                    <button
                        class="w-10 h-10 rounded-xl bg-white border border-gray-100 flex items-center justify-center text-gray-400 hover:text-primary shadow-sm">
                        <span class="material-symbols-outlined">mail</span>
                    </button>
                </div>

                <!-- User -->
                <div class="flex items-center gap-3 pl-6 border-l border-gray-100">
                    <img id="header-avatar" src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff"
                        class="w-10 h-10 rounded-lg object-cover shadow-sm">
                    <div class="hidden md:block">
                        <p class="text-sm font-bold text-[#1a3326]" id="header-name">Utente</p>
                        <p class="text-xs text-gray-400">Cliente</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Scrollable -->
        <div class="flex-1 overflow-auto p-8 relative">

            <!-- VIEW: HOME -->
            <div id="view-home" class="view-section">
                <div class="flex items-center gap-2 text-sm text-gray-400 mb-6">
                    <span>Pratiche</span>
                    <span class="material-symbols-outlined text-xs">chevron_right</span>
                    <span class="text-primary font-bold">Dettaglio</span>
                </div>

                <div class="grid grid-cols-12 gap-8">

                    <!-- LEFT COLUMN -->
                    <div class="col-span-12 xl:col-span-4 flex flex-col gap-6">

                        <!-- Profile Card -->
                        <div class="card p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-lg text-[#1a3326]">Profilo Cliente</h3>
                                <button class="text-gray-400 hover:text-primary"><span
                                        class="material-symbols-outlined text-lg">edit</span></button>
                            </div>

                            <div class="flex items-start gap-4 mb-6">
                                <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&size=128"
                                    class="w-20 h-20 rounded-2xl object-cover shadow-md">
                                <div>
                                    <h2 class="font-bold text-xl text-[#1a3326] mb-1" id="profile-name">Caricamento...
                                    </h2>
                                    <p class="text-sm text-gray-400 mb-2" id="profile-email">...</p>
                                    <span
                                        class="inline-block px-2 py-0.5 bg-green-100 text-green-600 text-[10px] font-bold uppercase tracking-wider rounded">Attivo</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-sm mb-8">
                                <div>
                                    <p class="text-xs text-gray-400 mb-0.5">Telefono</p>
                                    <p class="font-bold text-gray-700">+39 333 1234567</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-0.5">Città</p>
                                    <p class="font-bold text-gray-700">Cantù (CO)</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-0.5">Codice Fiscale</p>
                                    <p class="font-bold text-gray-700">RSS...H501Y</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-0.5">Registrazione</p>
                                    <p class="font-bold text-gray-700">12.03.2024</p>
                                </div>
                            </div>

                            <div class="border-t border-gray-100 pt-6 flex gap-4 text-center mb-6">
                                <div class="flex-1">
                                    <p class="text-3xl font-bold text-[#1a3326]">3</p>
                                    <p class="text-xs text-gray-400 uppercase tracking-wide mt-1">Pratiche Chiuse</p>
                                </div>
                                <div class="w-px bg-gray-100"></div>
                                <div class="flex-1">
                                    <p class="text-3xl font-bold text-primary">1</p>
                                    <p class="text-xs text-gray-400 uppercase tracking-wide mt-1">Pratica Attiva</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="sendMessage()"
                                    class="bg-[#4fffac] text-[#1a3326] font-bold py-2.5 rounded-xl hover:bg-[#2be68e] transition-colors shadow-sm shadow-green-200">
                                    Contatta
                                </button>
                                <button
                                    class="bg-white border border-gray-200 text-gray-600 font-bold py-2.5 rounded-xl hover:bg-gray-50 transition-colors">
                                    Dati Fiscali
                                </button>
                            </div>
                        </div>

                        <!-- Documents -->
                        <div class="card p-6 flex-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-lg text-[#1a3326]">Documenti Recenti</h3>
                                <div class="flex items-center gap-2">
                                    <input type="file" id="doc-upload-input" class="hidden" onchange="uploadFile()">
                                    <button onclick="document.getElementById('doc-upload-input').click()"
                                        class="text-primary text-sm font-bold flex items-center gap-1 hover:underline">
                                        Carica <span class="material-symbols-outlined text-sm">upload_file</span>
                                    </button>
                                </div>
                            </div>
                            <div id="docs-list" class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 text-center text-gray-400 text-xs py-4">Caricamento documenti...
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="col-span-12 xl:col-span-8 flex flex-col gap-6">

                        <!-- Appointments / Activities -->
                        <div class="card p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-lg text-[#1a3326]">Storico Attività</h3>
                                <div class="flex gap-4 text-sm font-medium">
                                    <button class="text-primary border-b-2 border-primary pb-1">Tutte le
                                        attività</button>
                                    <button class="text-gray-400 hover:text-gray-600">Prossime</button>
                                    <button class="text-gray-400 hover:text-gray-600">Completate</button>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="text-xs text-gray-400 uppercase font-medium border-b border-gray-100">
                                        <tr>
                                            <th class="py-3 px-4">Data</th>
                                            <th class="py-3 px-4">Tipologia</th>
                                            <th class="py-3 px-4">Stato</th>
                                            <th class="py-3 px-4 text-center">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr class="group hover:bg-gray-50 transition-colors">
                                            <td
                                                class="py-4 px-4 font-bold text-gray-700 bg-gray-50/50 rounded-l-xl my-1 block-table-cell">
                                                15.09.2025</td>
                                            <td class="py-4 px-4 text-gray-600">Udienza Preliminare</td>
                                            <td class="py-4 px-4"><span class="text-gray-400">-</span></td>
                                            <td class="py-4 px-4 text-center">
                                                <div
                                                    class="w-1 h-8 bg-primary absolute right-0 top-2 rounded-l-md opacity-0 group-hover:opacity-100">
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="group hover:bg-gray-50 transition-colors">
                                            <td class="py-4 px-4 font-bold text-gray-700 block-table-cell">23.07.2025
                                            </td>
                                            <td class="py-4 px-4 text-gray-600">Incontro in Studio</td>
                                            <td class="py-4 px-4"><span
                                                    class="text-green-500 font-bold text-xs uppercase bg-green-50 px-2 py-1 rounded-md">Eseguito</span>
                                            </td>
                                            <td class="py-4 px-4 text-center text-gray-400"><span
                                                    class="material-symbols-outlined text-sm">visibility_off</span></td>
                                        </tr>
                                        <tr class="group hover:bg-gray-50 transition-colors">
                                            <td class="py-4 px-4 font-bold text-gray-700 block-table-cell">13.02.2025
                                            </td>
                                            <td class="py-4 px-4 text-gray-600">Videocall Conoscitiva</td>
                                            <td class="py-4 px-4"><span
                                                    class="text-green-500 font-bold text-xs uppercase bg-green-50 px-2 py-1 rounded-md">Eseguito</span>
                                            </td>
                                            <td class="py-4 px-4 text-center text-gray-400"><span
                                                    class="material-symbols-outlined text-sm">visibility_off</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-50">
                                <button onclick="requestAppointment()"
                                    class="bg-[#4fffac] text-[#1a3326] px-6 py-3 rounded-xl font-bold text-sm hover:bg-[#2be68e] shadow-lg shadow-green-100 hover:shadow-green-200 transition-all transform hover:-translate-y-0.5">
                                    Richiedi Appuntamento
                                </button>
                                <button
                                    class="text-gray-400 hover:text-primary text-sm font-medium border border-gray-200 px-6 py-3 rounded-xl hover:bg-gray-50">
                                    Vedi tutto lo storico
                                </button>
                            </div>
                        </div>

                        <!-- Bottom Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
                            <!-- Notes -->
                            <div class="card p-6 flex flex-col">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg text-[#1a3326]">Note Legali</h3>
                                    <button class="text-primary text-sm font-bold flex items-center gap-1">Aggiungi
                                        <span class="material-symbols-outlined text-sm">add</span></button>
                                </div>
                                <div class="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 flex-1">
                                    <p class="text-sm text-gray-600 leading-relaxed">
                                        Ricordare di inviare copia del documento d'identità aggiornato entro la fine del
                                        mese per il completamento della pratica KY09.
                                    </p>
                                    <div class="flex justify-between items-center mt-4">
                                        <span class="text-xs text-yellow-600 font-bold">Nota #04</span>
                                        <span class="text-xs text-gray-400">12.02.2025</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payments -->
                            <div class="card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg text-[#1a3326]">Pagamenti</h3>
                                    <button class="text-primary text-sm font-bold flex items-center gap-1">Fatture <span
                                            class="material-symbols-outlined text-sm">receipt_long</span></button>
                                </div>
                                <div class="space-y-3">
                                    <div
                                        class="flex justify-between items-center py-2 border-b border-gray-50 border-dashed">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                            <span class="text-sm text-gray-600 font-medium">Acconto Pratica</span>
                                        </div>
                                        <span class="font-bold text-gray-800">500€</span>
                                    </div>
                                    <div
                                        class="flex justify-between items-center py-2 border-b border-gray-50 border-dashed">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                            <span class="text-sm text-gray-600 font-medium">Consulenza Prelim.</span>
                                        </div>
                                        <span class="font-bold text-gray-800">150€</span>
                                    </div>
                                    <div class="flex justify-between items-center pt-2">
                                        <span class="font-bold text-[#1a3326]">Totale da saldare</span>
                                        <span class="font-black text-xl text-red-500">500€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Recent Activity Card -->
                    <div
                        class="mt-8 col-span-1 lg:col-span-3 bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">La tua Storia (Attività Recenti)</h3>
                        <div id="client-activity-history" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Caricamento...</p>
                        </div>
                    </div>

                </div> <!-- END VIEW HOME -->

                <!-- VIEW: CALENDAR -->
                <div id="view-calendar" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-[#1a3326] mb-6">Il mio Calendario</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
                            <!-- Simple Month Grid (Mock) -->
                            <div class="grid grid-cols-7 gap-2 mb-4 text-center text-sm font-bold text-gray-600">
                                <div>Lun</div>
                                <div>Mar</div>
                                <div>Mer</div>
                                <div>Gio</div>
                                <div>Ven</div>
                                <div>Sab</div>
                                <div>Dom</div>
                            </div>
                            <div class="grid grid-cols-7 gap-2 text-center text-sm">
                                <div class="p-2 text-gray-300">29</div>
                                <div class="p-2 text-gray-300">30</div>
                                <div class="p-2">1</div>
                                <div class="p-2">2</div>
                                <div class="p-2">3</div>
                                <div class="p-2">4</div>
                                <div class="p-2">5</div>
                                <div class="p-2">6</div>
                                <div class="p-2">7</div>
                                <div class="p-2">8</div>
                                <div class="p-2">9</div>
                                <div class="p-2 bg-primary/20 rounded-lg font-bold text-primary">10</div>
                                <div class="p-2">11</div>
                                <div class="p-2">12</div>
                                <!-- ... truncated for brevity ... -->
                                <div class="p-2">...</div>
                            </div>
                            <p class="text-xs text-center text-gray-400 mt-4">*Calendario interattivo in arrivo*</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm flex flex-col">
                            <h3 class="font-bold text-lg mb-4">Prossimi Eventi</h3>
                            <div id="calendar-appointments-list" class="space-y-3 flex-1 overflow-y-auto max-h-60">
                                <p class="text-gray-400 text-sm text-center py-4">Nessun appuntamento.</p>
                            </div>
                            <button onclick="requestAppointment()"
                                class="w-full mt-4 bg-primary text-[#1a3326] font-bold py-3 rounded-xl hover:bg-primary-dark transition-colors">Richiedi
                                Nuovo</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MESSAGES -->
                <div id="view-messages" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-[#1a3326] mb-6">Messaggi</h2>
                    <div
                        class="bg-white rounded-2xl border border-gray-100 shadow-sm flex flex-col h-[calc(100vh-200px)]">
                        <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50/50">
                            <!-- Example Msg -->
                            <div class="flex justify-start">
                                <div
                                    class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm max-w-[80%]">
                                    <p class="text-sm text-gray-600">Benvenuto nella tua area riservata. Come possiamo
                                        aiutarti?</p>
                                    <span class="text-[10px] text-gray-400 mt-1 block">Admin • 10:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl">
                            <form onsubmit="event.preventDefault(); sendChatMessage();" class="flex gap-2">
                                <input type="text" id="chat-input" placeholder="Scrivi un messaggio..."
                                    class="flex-1 bg-gray-50 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary">
                                <button type="submit"
                                    class="bg-primary text-[#1a3326] p-3 rounded-xl hover:bg-primary-dark transition-colors"><span
                                        class="material-symbols-outlined">send</span></button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-[#1a3326] mb-6">Impostazioni Profilo</h2>
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-8 max-w-2xl">
                        <form onsubmit="event.preventDefault(); submitProfileUpdate();">
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Nome</label>
                                    <input type="text" id="set-name"
                                        class="w-full rounded-xl border-gray-200 bg-gray-50 font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Cognome</label>
                                    <input type="text" id="set-surname"
                                        class="w-full rounded-xl border-gray-200 bg-gray-50 font-medium">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Email</label>
                                <input type="email" id="set-email"
                                    class="w-full rounded-xl border-gray-200 bg-gray-50 font-medium" disabled>
                            </div>
                            <div class="mb-8">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nuova Password</label>
                                <input type="password" id="set-password" placeholder="********"
                                    class="w-full rounded-xl border-gray-200 bg-gray-50 font-medium">
                            </div>
                            <button type="submit"
                                class="bg-[#1a3326] text-white font-bold py-3 px-8 rounded-xl hover:bg-black transition-colors">Salva
                                Modifiche</button>
                        </form>
                    </div>
                </div>

            </div>

    </main>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/auth.js"></script>

    <!-- MODALS -->
    <!-- Appointment Modal - Increased Z-index -->
    <div id="modal-appointment"
        class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="font-bold text-xl text-[#1a3326] mb-4">Richiedi Appuntamento</h3>
            <form onsubmit="event.preventDefault(); submitAppointmentRequest();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data *</label>
                        <input type="date" id="req-date" required
                            class="w-full rounded-xl border-gray-200 bg-gray-50 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ora *</label>
                        <input type="time" id="req-time" required
                            class="w-full rounded-xl border-gray-200 bg-gray-50 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo *</label>
                        <select id="req-type" class="w-full rounded-xl border-gray-200 bg-gray-50 text-sm">
                            <option>Videocall Conoscitiva</option>
                            <option>Incontro in Studio</option>
                            <option>Consulenza Telefonica</option>
                            <option>Altro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Note</label>
                        <textarea id="req-notes" rows="3" class="w-full rounded-xl border-gray-200 bg-gray-50 text-sm"
                            placeholder="Dettagli aggiuntivi..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal('modal-appointment')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 hover:bg-gray-50">Annulla</button>
                    <button type="submit"
                        class="flex-1 py-3 rounded-xl bg-primary text-[#1a3326] font-bold hover:bg-primary-dark">Invia
                        Richiesta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoices Modal -->
    <div id="modal-invoices"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-[#1a3326]">Le tue Fatture</h3>
                <button onclick="closeModal('modal-invoices')" class="p-2 hover:bg-gray-100 rounded-full"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full text-left border-collapse">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                        <tr>
                            <th class="p-3 rounded-l-lg">Numero</th>
                            <th class="p-3">Data</th>
                            <th class="p-3">Importo</th>
                            <th class="p-3">Stato</th>
                            <th class="p-3 rounded-r-lg text-right">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="invoices-list-body" class="text-sm">
                        <tr>
                            <td colspan="5" class="text-center py-4 text-gray-400">Caricamento...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="modal-notes"
        class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold text-xl text-[#1a3326] mb-4">Aggiungi Nota Personale</h3>
            <form onsubmit="event.preventDefault(); submitNote();">
                <textarea id="note-content" required rows="5"
                    class="w-full rounded-xl border-gray-200 bg-gray-50 text-sm mb-4"
                    placeholder="Scrivi qui la tua nota..."></textarea>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('modal-notes')"
                        class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 hover:bg-gray-50">Annulla</button>
                    <button type="submit"
                        class="flex-1 py-3 rounded-xl bg-primary text-[#1a3326] font-bold hover:bg-primary-dark">Salva
                        Nota</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Init Date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = now.toLocaleDateString('it-IT', options).replace(',', '');

        let currentUser = null;
        let socket = null;

        // --- SOCKET.IO INIT ---
        const SOCKET_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://' + window.location.hostname + ':3000';
        try {
            socket = io('http://localhost:3000'); // Check endpoint in prod

            socket.on('connect', () => {
                console.log("Connected to Socket Server");
                if (currentUser) socket.emit('join', { user_id: currentUser.id }); // Optional room logic
            });

            // 1. Messaggi
            socket.on('client_message_notification', (data) => {
                // Check if msg is for me (if broadcast)
                if (currentUser && data.recipient_id == currentUser.id) {
                    showToast(`Nuovo messaggio da Admin`, 'info');
                    playNotificationSound();
                    fetchData(currentUser.id, localStorage.getItem('userToken'));
                }
            });

            // 2. Appuntamenti
            socket.on('client_appointment_update', (data) => {
                // If data.client_id matches or broadcast...
                // Ideally check ID. Assuming broadcast for now or filtered by server
                showToast(`Aggiornamento Appuntamento: ${data.status}`, 'info');
                fetchData(currentUser.id, localStorage.getItem('userToken'));
            });

            // 3. Notifiche Generali
            socket.on('client_general_notification', (data) => {
                showToast(data.message, 'info');
            });

        } catch (e) { console.error("Socket Init Error", e); }


        if (AuthService.isAuthenticated()) {
            currentUser = AuthService.getSession();
            const token = localStorage.getItem('userToken');

            if (currentUser) {
                updateProfileUI(currentUser);
                fetchData(currentUser.id, token);

                // Polling Fallback
                setInterval(() => {
                    if (document.visibilityState === 'visible') fetchData(currentUser.id, token);
                }, 10000);
            }
        } else {
            window.location.href = 'login.html';
        }

        function updateProfileUI(user) {
            try {
                const fullName = (user.first_name || 'Utente') + ' ' + (user.last_name || '');
                document.getElementById('header-name').innerText = fullName;
                document.getElementById('profile-name').innerText = fullName;
                document.getElementById('profile-email').innerText = user.email;

                const avatarUrl = `https://ui-avatars.com/api/?name=${user.first_name}+${user.last_name}&background=0D8ABC&color=fff`;
                document.getElementById('header-avatar').src = avatarUrl;
                document.getElementById('profile-avatar').src = avatarUrl;

                // Also update settings form if user exists
                loadSettings(user);

            } catch (e) { console.error(e); }
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            // Try/catch for event.target if called programmatically
            try {
                if (event && event.target) event.target.closest('.sidebar-link')?.classList.add('active');
            } catch (e) { }

            if (viewId === 'messages') {
                scrollToBottomChat();
                document.getElementById('msg-badge').classList.add('hidden');
            }
            if (viewId === 'settings' && currentUser) {
                loadSettings(currentUser);
            }
        }

        function scrollToBottomChat() {
            const c = document.getElementById('messages-container');
            if (c) setTimeout(() => c.scrollTop = c.scrollHeight, 100);
        }

        async function fetchData(userId, token) {
            try {
                const response = await fetch('api/get_client_data.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, token: token })
                });
                const result = await response.json();

                if (result.success) {
                    if (result.user) {
                        currentUser = result.user; // Update local user
                        updateProfileUI(result.user);
                        loadSettings(result.user); // Fix for Issue 5 (Settings Empty)
                    }

                    try { renderAppointments(result.appointments); } catch (e) { }
                    try { loadClientDocuments(userId); } catch (e) { }
                    try { loadClientActivity(userId); } catch (e) { }

                    // Always render messages to update badge, even if view is hidden
                    try { renderMessages(result.messages); } catch (e) { }
                }
            } catch (e) { console.error(e); }
        }

        // --- APPOINTMENTS ---
        function openAppointmentModal() {
            document.getElementById('modal-appointment').classList.remove('hidden');
        }
        window.requestAppointment = openAppointmentModal;

        async function submitAppointmentRequest() {
            const date = document.getElementById('req-date').value;
            const time = document.getElementById('req-time').value;
            const type = document.getElementById('req-type').value;
            const notes = document.getElementById('req-notes').value;

            if (!date || !time) return alert("Inserisci data e ora");

            try {
                const response = await fetch('api/manage_appointments.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: currentUser.id, // Ensure this is set
                        date: date,
                        time: time,
                        type: type,
                        notes: notes
                    })
                });
                const res = await response.json();
                if (res.success) {
                    closeModal('modal-appointment');
                    showToast('Richiesta inviata con successo!', 'success');

                    if (socket) socket.emit('appointment_requested', {
                        client_id: currentUser.id,
                        name: currentUser.first_name + ' ' + currentUser.last_name,
                        date: date,
                        time: time,
                        type: type
                    });

                    fetchData(currentUser.id, localStorage.getItem('userToken'));
                } else {
                    alert("Errore: " + res.message);
                }
            } catch (e) { console.error(e); alert("Errore invio"); }
        }

        function renderAppointments(list) {
            // Calendar Side List
            const calendarList = document.getElementById('calendar-appointments-list');
            if (calendarList) {
                if (!list || list.length === 0) {
                    calendarList.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Nessun appuntamento.</p>';
                } else {
                    calendarList.innerHTML = list.slice(0, 10).map(app => `
                         <div class="p-3 bg-gray-50 rounded-xl border-l-4 ${app.status === 'Confermato' ? 'border-primary' : 'border-yellow-400'}">
                            <p class="font-bold text-sm text-gray-800">${app.type}</p>
                            <p class="text-xs text-gray-500">${new Date(app.date).toLocaleString([], { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                            <span class="text-[10px] uppercase font-bold text-gray-400">${app.status}</span>
                        </div>
                    `).join('');
                }
            }
        }

        // --- DOCUMENTS ---
        async function loadClientDocuments(userId) {
            const container = document.getElementById('docs-list');
            try {
                const response = await fetch(`api/get_documents.php?user_id=${userId}`);
                const res = await response.json();
                if (res.success) renderDocuments(res.documents);
                else if (container) container.innerHTML = `<div class="col-span-2 text-center text-gray-400 text-sm py-4">Nessun file.</div>`;
            } catch (e) {
                if (container) container.innerHTML = `<div class="col-span-2 text-center text-red-400 text-sm py-4">Errore caricamento.</div>`;
            }
        }

        function renderDocuments(documents) {
            const container = document.getElementById('docs-list');
            if (!container) return;
            if (!documents || documents.length === 0) {
                container.innerHTML = `<div class="col-span-2 text-center text-gray-400 text-sm py-4">Nessun file caricato.</div>`;
                return;
            }
            container.innerHTML = documents.map(doc => `
                  <div class="p-3 rounded-xl border border-gray-100 hover:border-primary/50 cursor-pointer transition-all group bg-gray-50/50" onclick="window.open('${doc.file_path}', '_blank')">
                     <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition-colors shrink-0">
                             <span class="material-symbols-outlined text-[18px]">description</span>
                         </div>
                         <div class="overflow-hidden">
                             <h4 class="font-bold text-xs text-gray-700 truncate" title="${doc.title}">${doc.title}</h4>
                             <p class="text-[10px] text-gray-400 mt-0.5">${new Date(doc.upload_date).toLocaleDateString()}</p>
                         </div>
                     </div>
                 </div>
             `).join('');
        }

        async function uploadFile() {
            const input = document.getElementById('doc-upload-input');
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', currentUser.id);

            try {
                showToast("Caricamento in corso...", "info");
                const response = await fetch('api/upload_document.php', { method: 'POST', body: formData });
                const res = await response.json();
                if (res.success) {
                    showToast("Documento caricato!", "success");
                    loadClientDocuments(currentUser.id);

                    if (socket) socket.emit('document_uploaded', {
                        client_id: currentUser.id,
                        name: currentUser.first_name + ' ' + currentUser.last_name,
                        file_name: file.name
                    });
                } else {
                    showToast("Errore: " + res.message, "error");
                }
            } catch (e) { console.error(e); alert("Errore Upload"); }
        }

        // --- MESSAGES ---
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            if (!messages) return;

            // Unread Badge
            const unread = messages.filter(m => m.sender_role !== 'client' && !m.is_read).length; // Need fetch to return is_read or just assume new
            const badge = document.getElementById('msg-badge');
            if (badge) {
                if (unread > 0) {
                    badge.innerText = unread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            if (!container) return; // If container not present (e.g. wrong page), skip rest

            if (messages.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 text-sm py-10">Inizia una conversazione con lo studio.</div>`;
                return;
            }

            // Simple diff to avoid full redraw if possible? For now full redraw is safer for sync
            const html = messages.map(m => `
                <div class="flex ${m.sender_role === 'client' ? 'justify-end' : 'justify-start'}">
                     <div class="${m.sender_role === 'client' ? 'bg-primary/20 border-primary/20' : 'bg-white border-gray-100'} p-3 rounded-2xl ${m.sender_role === 'client' ? 'rounded-tr-none' : 'rounded-tl-none'} border shadow-sm max-w-[80%]">
                        <p class="text-sm text-gray-800 break-words">${m.content || m.message}</p>
                        <span class="text-[10px] text-gray-400 mt-1 block text-right">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                     </div>
                </div>
            `).join('');

            container.innerHTML = html;
            // Scroll to bottom if visible
            if (!document.getElementById('view-messages').classList.contains('hidden')) {
                scrollToBottomChat();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            try {
                const response = await fetch('api/send_message.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id, message: msg, sender_role: 'client' })
                });
                const res = await response.json();
                if (res.success) {
                    input.value = '';
                    fetchData(currentUser.id, localStorage.getItem('userToken'));

                    if (socket) {
                        socket.emit('message_sent', {
                            sender_id: currentUser.id,
                            sender_name: currentUser.first_name + ' ' + currentUser.last_name,
                            content: msg
                        });
                    }
                }
            } catch (e) { console.error(e); }
        }

        // --- INVOICES ---
        function openInvoicesModal() {
            document.getElementById('modal-invoices').classList.remove('hidden');
            loadInvoices();
        }
        window.openInvoicesModal = openInvoicesModal;

        async function loadInvoices() {
            const tbody = document.getElementById('invoices-list-body');
            try {
                const response = await fetch(`api/get_invoices.php?client_id=${currentUser.id}`);
                const res = await response.json();
                if (res.success && res.data.length > 0) {
                    tbody.innerHTML = res.data.map(inv => `
                        <tr class="border-b border-gray-50">
                            <td class="p-3 font-medium text-gray-800">${inv.number}</td>
                            <td class="p-3 text-gray-600">${new Date(inv.date).toLocaleDateString()}</td>
                            <td class="p-3 font-bold text-gray-800">€${inv.amount}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${inv.status === 'paid' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${inv.status === 'paid' ? 'Pagata' : 'Da Saldare'}</span></td>
                            <td class="p-3 text-right">
                                ${inv.pdf_url ? `<a href="${inv.pdf_url}" target="_blank" class="text-primary hover:underline font-bold text-xs">Scarica</a>` : '<span class="text-gray-300">-</span>'}
                            </td>
                        </tr>
                     `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">Nessuna fattura trovata.</td></tr>';
                }
            } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Errore caricamento</td></tr>'; }
        }

        // --- NOTES ---
        function openNotesModal() {
            document.getElementById('modal-notes').classList.remove('hidden');
        }
        window.openNotesModal = openNotesModal;

        async function submitNote() {
            const content = document.getElementById('note-content').value;
            if (!content) return;

            try {
                const response = await fetch('api/save_note.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: currentUser.id, content: content })
                });
                const res = await response.json();
                if (res.success) {
                    closeModal('modal-notes');
                    document.getElementById('note-content').value = '';
                    showToast("Nota salvata!", "success");
                }
            } catch (e) { console.error(e); }
        }

        // --- PROFILE SETTINGS ---
        function loadSettings(user) {
            document.getElementById('set-name').value = user.first_name || '';
            document.getElementById('set-surname').value = user.last_name || '';
            document.getElementById('set-email').value = user.email || '';
        }

        async function submitProfileUpdate() {
            const name = document.getElementById('set-name').value;
            const surname = document.getElementById('set-surname').value;
            const password = document.getElementById('set-password').value;

            try {
                const response = await fetch('api/update_profile.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id, // Fixed param name
                        first_name: name,
                        last_name: surname,
                        password: password
                    })
                });
                const res = await response.json();
                if (res.success) {
                    showToast("Profilo aggiornato!", "success");
                    // Refresh token? Or just data
                    // Actually if name changes, auth session might need update, 
                    // but for now just refresh data
                    fetchData(currentUser.id, localStorage.getItem('userToken'));
                } else {
                    alert("Errore: " + res.message);
                }
            } catch (e) { console.error(e); alert("Errore aggiornamento"); }
        }


        // --- UTILS ---
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        window.closeModal = closeModal;

        function showToast(msg, type = 'success') {
            const d = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-gray-800');
            const icon = type === 'success' ? 'check_circle' : (type === 'error' ? 'error' : 'info');

            d.className = `fixed top-4 right-4 z-[99] px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform transition-all translate-y-[-100px] opacity-0 text-white ${bg}`;
            d.innerHTML = `<span class="material-symbols-outlined">${icon}</span> <p class="font-bold text-sm">${msg}</p>`;
            document.body.appendChild(d);

            setTimeout(() => {
                d.classList.remove('translate-y-[-100px]', 'opacity-0');
            }, 100);

            setTimeout(() => {
                d.classList.add('translate-y-[-100px]', 'opacity-0');
                setTimeout(() => d.remove(), 500);
            }, 3000);
        }

        function playNotificationSound() {
            // Implementation for sound if needed
        }

        async function loadClientActivity(userId) {
            const container = document.getElementById('client-activity-history');
            if (!container) return;
            // Placeholder logic or actual fetch
            // container.innerHTML = ...
        }

    </script>
</body>

</html>